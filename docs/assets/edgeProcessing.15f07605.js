import{n as dt}from"./deduplicate.3f309ea7.js";import{T as U}from"./InterleavedLayout.fa84b36d.js";import{O as u}from"./VertexAttribute.42396f25.js";import{C as D}from"./enums.23a7fab5.js";import{t as At}from"./VertexElementDescriptor.1fdca6da.js";import{aB as nt,cI as ht,cJ as Ot,cK as W,cL as ot,cM as K,cN as St,cO as wt,cP as ft,cQ as rt,cR as ut,cS as Tt,an as E,cT as Et,cU as vt}from"./index.a113d2e4.js";function Y(t,e=0){const o=t.stride;return t.fieldNames.filter(s=>{const r=t.fields.get(s).optional;return!(r&&r.glPadding)}).map(s=>{const r=t.fields.get(s),i=r.constructor.ElementCount,m=$t(r.constructor.ElementType),a=r.offset,p=!(!r.optional||!r.optional.glNormalized);return new At(s,i,m,a,o,p,e)})}function $t(t){const e=Pt[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}const Pt={u8:D.UNSIGNED_BYTE,u16:D.UNSIGNED_SHORT,u32:D.UNSIGNED_INT,i8:D.BYTE,i16:D.SHORT,i32:D.INT,f32:D.FLOAT},yt=U().vec3f(u.POSITION).u16(u.COMPONENTINDEX).u16(u.U16PADDING),Dt=U().vec2u8(u.SIDENESS);Y(Dt);const gt=U().vec3f(u.POSITION0).vec3f(u.POSITION1).u16(u.COMPONENTINDEX).u8(u.VARIANTOFFSET,{glNormalized:!0}).u8(u.VARIANTSTROKE).u8(u.VARIANTEXTENSION,{glNormalized:!0}).u8(u.U8PADDING,{glPadding:!0}).u16(u.U16PADDING,{glPadding:!0}),X=gt.clone().vec3f(u.NORMAL),z=gt.clone().vec3f(u.NORMALA).vec3f(u.NORMALB);u.POSITION0,u.POSITION1,u.COMPONENTINDEX,u.VARIANTOFFSET,u.VARIANTSTROKE,u.VARIANTEXTENSION,u.NORMAL,u.NORMALA,u.NORMALB,u.SIDENESS;const L=-1;var st;function Lt(t,e,o,s=_t){const r=t.vertices.position,i=t.vertices.componentIndex,m=nt(s.anglePlanar),a=nt(s.angleSignificantEdge),p=Math.cos(a),l=Math.cos(m),f=k.edge,d=f.position0,A=f.position1,I=f.faceNormal0,v=f.faceNormal1,h=Ut(t),$=xt(t),n=$.length/4,c=e.allocate(n);let g=0;const N=n,O=o.allocate(N);let T=0,P=0,S=0;const Q=ht(0,n),_=new Float32Array(n);Ot(_,(V,w,x)=>{r.getVec($[4*w+0],d),r.getVec($[4*w+1],A),x[w]=Tt(d,A)}),Q.sort((V,w)=>_[w]-_[V]);const Z=new Array,tt=new Array;for(let V=0;V<n;V++){const w=Q[V],x=_[w],G=$[4*w+0],It=$[4*w+1],M=$[4*w+2],F=$[4*w+3],et=F===L;if(r.getVec(G,d),r.getVec(It,A),et)W(I,h[3*M+0],h[3*M+1],h[3*M+2]),ot(v,I),f.componentIndex=i.get(G),f.cosAngle=K(I,v);else{if(W(I,h[3*M+0],h[3*M+1],h[3*M+2]),W(v,h[3*F+0],h[3*F+1],h[3*F+2]),f.componentIndex=i.get(G),f.cosAngle=K(I,v),Mt(f,l))continue;f.cosAngle<-.9999&&ot(v,I)}P+=x,S++,et||Vt(f,p)?(e.write(c,g++,f),Z.push(x)):Rt(f,m)&&(o.write(O,T++,f),tt.push(x))}const mt=new Float32Array(Z.reverse()),pt=new Float32Array(tt.reverse());return{regular:{instancesData:e.trim(c,g),lodInfo:{lengths:mt}},silhouette:{instancesData:o.trim(O,T),lodInfo:{lengths:pt}},averageEdgeLength:P/S}}function Vt(t,e){return t.cosAngle<e}function Mt(t,e){return t.cosAngle>e}function Rt(t,e){const o=St(t.cosAngle),s=k.fwd,r=k.ortho;return wt(s,t.position1,t.position0),o*(K(ft(r,t.faceNormal0,t.faceNormal1),s)>0?-1:1)>e}function xt(t){const e=t.faces.length/3,o=t.faces,s=t.neighbors;let r=0;for(let a=0;a<e;a++){const p=s[3*a+0],l=s[3*a+1],f=s[3*a+2],d=o[3*a+0],A=o[3*a+1],I=o[3*a+2];r+=p===L||d<A?1:0,r+=l===L||A<I?1:0,r+=f===L||I<d?1:0}const i=new Int32Array(4*r);let m=0;for(let a=0;a<e;a++){const p=s[3*a+0],l=s[3*a+1],f=s[3*a+2],d=o[3*a+0],A=o[3*a+1],I=o[3*a+2];(p===L||d<A)&&(i[m++]=d,i[m++]=A,i[m++]=a,i[m++]=p),(l===L||A<I)&&(i[m++]=A,i[m++]=I,i[m++]=a,i[m++]=l),(f===L||I<d)&&(i[m++]=I,i[m++]=d,i[m++]=a,i[m++]=f)}return i}function Ut(t){const e=t.faces.length/3,o=t.vertices.position,s=t.faces,r=H.v0,i=H.v1,m=H.v2,a=new Float32Array(3*e);for(let p=0;p<e;p++){const l=s[3*p+0],f=s[3*p+1],d=s[3*p+2];o.getVec(l,r),o.getVec(f,i),o.getVec(d,m),rt(i,i,r),rt(m,m,r),ft(r,i,m),ut(r,r),a[3*p+0]=r[0],a[3*p+1]=r[1],a[3*p+2]=r[2]}return a}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(st||(st={}));const k={edge:{position0:E(),position1:E(),faceNormal0:E(),faceNormal1:E(),componentIndex:0,cosAngle:0},ortho:E(),fwd:E()},H={v0:E(),v1:E(),v2:E()},_t={anglePlanar:4,angleSignificantEdge:35};function ct(t,e,o){const s=e/3,r=new Uint32Array(o+1),i=new Uint32Array(o+1),m=(n,c)=>{n<c?r[n+1]++:i[c+1]++};for(let n=0;n<s;n++){const c=t[3*n],g=t[3*n+1],N=t[3*n+2];m(c,g),m(g,N),m(N,c)}let a=0,p=0;for(let n=0;n<o;n++){const c=r[n+1],g=i[n+1];r[n+1]=a,i[n+1]=p,a+=c,p+=g}const l=new Uint32Array(6*s),f=r[o],d=(n,c,g)=>{if(n<c){const N=r[n+1]++;l[2*N]=c,l[2*N+1]=g}else{const N=i[c+1]++;l[2*f+2*N]=n,l[2*f+2*N+1]=g}};for(let n=0;n<s;n++){const c=t[3*n],g=t[3*n+1],N=t[3*n+2];d(c,g,n),d(g,N,n),d(N,c,n)}const A=(n,c)=>{const g=2*n,N=c-n;for(let O=1;O<N;O++){const T=l[g+2*O],P=l[g+2*O+1];let S=O-1;for(;S>=0&&l[g+2*S]>T;S--)l[g+2*S+2]=l[g+2*S],l[g+2*S+3]=l[g+2*S+1];l[g+2*S+2]=T,l[g+2*S+3]=P}};for(let n=0;n<o;n++)A(r[n],r[n+1]),A(f+i[n],f+i[n+1]);const I=new Int32Array(3*s),v=(n,c)=>n===t[3*c]?0:n===t[3*c+1]?1:n===t[3*c+2]?2:-1,h=(n,c)=>{const g=v(n,c);I[3*c+g]=-1},$=(n,c,g,N)=>{const O=v(n,c);I[3*c+O]=N;const T=v(g,N);I[3*N+T]=c};for(let n=0;n<o;n++){let c=r[n];const g=r[n+1];let N=i[n];const O=i[n+1];for(;c<g&&N<O;){const T=l[2*c],P=l[2*f+2*N];T===P?($(n,l[2*c+1],P,l[2*f+2*N+1]),c++,N++):T<P?(h(n,l[2*c+1]),c++):(h(P,l[2*f+2*N+1]),N++)}for(;c<g;)h(n,l[2*c+1]),c++;for(;N<O;)h(l[2*f+2*N],l[2*f+2*N+1]),N++}return I}class Nt{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?Bt:Ft}write(e,o,s){const r=this._edgeHashFunction(s);C.seed=r;const i=C.getIntRange(0,255),m=C.getIntRange(0,this.settings.variants-1),a=.7,p=C.getFloat(),l=255*(.5*Ct(-(1-Math.min(p/a,1))+Math.max(0,p-a)/(1-a),1.2)+.5);e.position0.setVec(o,s.position0),e.position1.setVec(o,s.position1),e.componentIndex.set(o,s.componentIndex),e.variantOffset.set(o,i),e.variantStroke.set(o,m),e.variantExtension.set(o,l)}trim(e,o){return e.slice(0,o)}}const j=new Float32Array(6),b=new Uint32Array(j.buffer),y=new Uint32Array(1);function Ft(t){const e=j;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],y[0]=5381;for(let o=0;o<b.length;o++)y[0]=31*y[0]+b[o];return y[0]}function Bt(t){const e=j;e[0]=R(t.position0[0]),e[1]=R(t.position0[1]),e[2]=R(t.position0[2]),e[3]=R(t.position1[0]),e[4]=R(t.position1[1]),e[5]=R(t.position1[2]),y[0]=5381;for(let o=0;o<b.length;o++)y[0]=31*y[0]+b[o];return y[0]}const it=1e4;function R(t){return Math.round(t*it)/it}function Ct(t,e){const o=t<0?-1:1;return Math.abs(t)**e*o}class q{constructor(){this._commonWriter=new Nt}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return X.createBuffer(e)}write(e,o,s){this._commonWriter.write(e,o,s),Et(B,s.faceNormal0,s.faceNormal1),ut(B,B),e.normal.setVec(o,B)}trim(e,o){return this._commonWriter.trim(e,o)}}q.Layout=X,q.glLayout=Y(X,1);class J{constructor(){this._commonWriter=new Nt}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return z.createBuffer(e)}write(e,o,s){this._commonWriter.write(e,o,s),e.normalA.setVec(o,s.faceNormal0),e.normalB.setVec(o,s.faceNormal1)}trim(e,o){return this._commonWriter.trim(e,o)}}J.Layout=z,J.glLayout=Y(z,1);const B=E(),C=new vt;function kt(t){const e=bt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return at.updateSettings(t.writerSettings),lt.updateSettings(t.writerSettings),Lt(e,at,lt)}function bt(t,e,o,s){if(e)return{faces:o,facesLength:s,neighbors:ct(o,s,t.count),vertices:t};const r=dt(t.buffer,t.stride/4,{originalIndices:o,originalIndicesLength:s}),i=ct(r.indices,s,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:i,vertices:yt.createView(r.buffer)}}const at=new q,lt=new J,qt=U().vec3f(u.POSITION0).vec3f(u.POSITION1),Jt=U().vec3f(u.POSITION0).vec3f(u.POSITION1).u16(u.COMPONENTINDEX).u16(u.U16PADDING,{glPadding:!0});export{yt as A,Jt as a,qt as d,kt as f,Lt as h,bt as u};
