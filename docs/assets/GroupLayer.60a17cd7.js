import{F as o,H as d,I as b,j as v,bj as f,bB as m,bd as _,f as y,ew as L,ex as w,bt as M,bu as x,bv as C,aM as u,r as O,ey as $,bm as A,dt as c}from"./index.a113d2e4.js";import{p as g}from"./CollectionFlattener.0988f486.js";import{n as I}from"./loadAll.c39d6245.js";import{a as T}from"./lazyLayerLoader.2408f35c.js";import{y as V}from"./writeUtils.a7b7f9cb.js";import"./layerUtils.8c5cf1f0.js";function F(t){return new g({getCollections:()=>[t.tables,t.layers],getChildrenFunction:s=>{const e=[];return"tables"in s&&e.push(s.tables),"layers"in s&&e.push(s.layers),e},itemFilterFunction:s=>{const e=s.parent;return e&&"tables"in e&&e.tables.includes(s)}})}function h(t,s,e){let i,r;if(t)for(let l=0,a=t.length;l<a;l++){if(i=t.getItemAt(l),i[s]===e)return i;if((i==null?void 0:i.type)==="group"&&(r=h(i.layers,s,e),r))return r}}const R=t=>{let s=class extends t{constructor(...e){super(...e),this.layers=new v;const i=a=>{a.parent&&"remove"in a.parent&&a.parent.remove(a)},r=a=>{a.parent=this,this.layerAdded(a),a.type!=="elevation"&&a.type!=="base-elevation"||y.getLogger(this.declaredClass).error(`Layer 'title:${a.title}, id:${a.id}' of type '${a.type}' is not supported as an operational layer and will therefore be ignored.`)},l=a=>{a.parent=null,this.layerRemoved(a)};this.layers.on("before-add",a=>i(a.item)),this.layers.on("after-add",a=>r(a.item)),this.layers.on("after-remove",a=>l(a.item))}destroy(){const e=this.layers.removeAll();for(const i of e)this.layerRemoved(i),i.destroy();this.layers.destroy()}set layers(e){this._set("layers",f(e,this._get("layers")))}add(e,i){const r=this.layers;if(i=r.getNextIndex(i),e instanceof m){const l=e;l.parent===this?this.reorder(l,i):r.add(l,i)}else _(e)?e.then(l=>{this.destroyed||this.add(l,i)}):y.getLogger(this.declaredClass).error("#add()","The item being added is not a Layer or a Promise that resolves to a Layer.")}addMany(e,i){const r=this.layers;i=r.getNextIndex(i),e.slice().forEach(l=>{l.parent!==this?(r.add(l,i),i+=1):this.reorder(l,i)})}findLayerById(e){return h(this.layers,"id",e)}findLayerByUid(e){return h(this.layers,"uid",e)}remove(e){return this.layers.remove(e)}removeMany(e){return this.layers.removeMany(e)}removeAll(){return this.layers.removeAll()}reorder(e,i){return this.layers.reorder(e,i)}layerAdded(e){}layerRemoved(e){}};return o([d()],s.prototype,"layers",null),s=o([b("esri.support.LayersMixin")],s),s};function p(t,s,e){if(t)for(let i=0,r=t.length;i<r;i++){const l=t.getItemAt(i);if(l[s]===e)return l;if((l==null?void 0:l.type)==="group"){const a=p(l.tables,s,e);if(a)return a}}}const E=t=>{let s=class extends t{constructor(...e){super(...e),this.tables=new v,this.tables.on("after-add",i=>{const r=i.item;r.parent&&r.parent!==this&&"tables"in r.parent&&r.parent.tables.remove(r),r.parent=this,r.type!=="feature"&&y.getLogger(this.declaredClass).error(`Layer 'title:${r.title}, id:${r.id}' of type '${r.type}' is not supported as a table and will therefore be ignored.`)}),this.tables.on("after-remove",i=>{i.item.parent=null})}destroy(){const e=this.tables.removeAll();for(const i of e)i.destroy();this.tables.destroy()}set tables(e){this._set("tables",f(e,this._get("tables")))}findTableById(e){return p(this.tables,"id",e)}findTableByUid(e){return p(this.tables,"uid",e)}};return o([d()],s.prototype,"tables",null),s=o([b("esri.support.TablesMixin")],s),s};let n=class extends L(w(M(x(E(R(C(m))))))){constructor(t){super(t),this._visibilityHandles={},this.allLayers=new g({getCollections:()=>[this.layers],getChildrenFunction:s=>"layers"in s?s.layers:null}),this.allTables=F(this),this.fullExtent=void 0,this.operationalLayerType="GroupLayer",this.spatialReference=void 0,this.type="group"}initialize(){this._enforceVisibility(this.visibilityMode,this.visible),this.addHandles(u(()=>this.visible,this._onVisibilityChange.bind(this),c))}_writeLayers(t,s,e,i){const r=[];if(!t)return r;t.forEach(l=>{const a=V(l,i.webmap?i.webmap.getLayerJSONFromResourceInfo(l):null,i);O(a)&&a.layerType&&r.push(a)}),s.layers=r}set portalItem(t){this._set("portalItem",t)}set visibilityMode(t){const s=this._get("visibilityMode")!==t;this._set("visibilityMode",t),s&&this._enforceVisibility(t,this.visible)}load(t){return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection","Scene Service"],layerModuleTypeMap:T},t)),Promise.resolve(this)}loadAll(){return I(this,t=>{t(this.layers,this.tables)})}layerAdded(t){t.visible&&this.visibilityMode==="exclusive"?this._turnOffOtherLayers(t):this.visibilityMode==="inherited"&&(t.visible=this.visible),this._visibilityHandles[t.uid]=u(()=>t.visible,s=>this._onChildVisibilityChange(t,s),c)}layerRemoved(t){const s=this._visibilityHandles[t.uid];s&&(s.remove(),delete this._visibilityHandles[t.uid]),this._enforceVisibility(this.visibilityMode,this.visible)}_turnOffOtherLayers(t){this.layers.forEach(s=>{s!==t&&(s.visible=!1)})}_enforceVisibility(t,s){if(!$(this).initialized)return;const e=this.layers;let i=e.find(r=>r.visible);switch(t){case"exclusive":e.length&&!i&&(i=e.getItemAt(0),i.visible=!0),this._turnOffOtherLayers(i);break;case"inherited":e.forEach(r=>{r.visible=s})}}_onVisibilityChange(t){this.visibilityMode==="inherited"&&this.layers.forEach(s=>{s.visible=t})}_onChildVisibilityChange(t,s){switch(this.visibilityMode){case"exclusive":s?this._turnOffOtherLayers(t):this._isAnyLayerVisible()||(t.visible=!0);break;case"inherited":t.visible=this.visible}}_isAnyLayerVisible(){return this.layers.some(t=>t.visible)}};o([d({readOnly:!0,dependsOn:[]})],n.prototype,"allLayers",void 0),o([d({readOnly:!0})],n.prototype,"allTables",void 0),o([d()],n.prototype,"fullExtent",void 0),o([d({json:{read:!1,write:{ignoreOrigin:!0}}})],n.prototype,"layers",void 0),o([A("layers")],n.prototype,"_writeLayers",null),o([d({type:["GroupLayer"]})],n.prototype,"operationalLayerType",void 0),o([d({json:{origins:{"web-document":{read:!1,write:!1}}}})],n.prototype,"portalItem",null),o([d()],n.prototype,"spatialReference",void 0),o([d({json:{read:!1},readOnly:!0,value:"group"})],n.prototype,"type",void 0),o([d({type:["independent","inherited","exclusive"],value:"independent",json:{write:!0,origins:{"web-map":{read:!1,write:!1}}}})],n.prototype,"visibilityMode",null),n=o([b("esri.layers.GroupLayer")],n);const N=n;export{N as default};
