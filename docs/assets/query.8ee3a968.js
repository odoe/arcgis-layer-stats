import{r as o,v as E,D as g,a as O,L as R,G as F}from"./index.96cac272.js";import{L as j}from"./normalizeUtils.28ae413c.js";import{t as b}from"./pbfQueryUtils.b5665f2d.js";function m(r){const t={};for(const i in r){if(i==="declaredClass")continue;const e=r[i];if(e!=null&&typeof e!="function")if(Array.isArray(e)){t[i]=[];for(let n=0;n<e.length;n++)t[i][n]=m(e[n])}else typeof e=="object"?e.toJSON&&(t[i]=JSON.stringify(e)):t[i]=e}return t}const f="Layer does not support extent calculation.";function p(r,t){if(t&&r.type==="extent")return`${r.xmin},${r.ymin},${r.xmax},${r.ymax}`;if(t&&r.type==="point")return`${r.x},${r.y}`;const i=r.toJSON();return delete i.spatialReference,JSON.stringify(i)}function S(r,t){const i=r.geometry,e=r.toJSON();delete e.compactGeometryEnabled,delete e.defaultSpatialReferenceEnabled;const n=e;let a,u,c;if(o(i)&&(u=i.spatialReference,c=i.spatialReference.wkid||JSON.stringify(i.spatialReference),n.geometryType=E(i),n.geometry=p(i,r.compactGeometryEnabled),n.inSR=c),e.groupByFieldsForStatistics&&(n.groupByFieldsForStatistics=e.groupByFieldsForStatistics.join(",")),e.objectIds&&(n.objectIds=e.objectIds.join(",")),e.orderByFields&&(n.orderByFields=e.orderByFields.join(",")),!e.outFields||!e.returnDistinctValues&&((t==null?void 0:t.returnCountOnly)||(t==null?void 0:t.returnExtentOnly)||(t==null?void 0:t.returnIdsOnly))?delete n.outFields:e.outFields.includes("*")?n.outFields="*":n.outFields=e.outFields.join(","),e.outSR?(n.outSR=e.outSR.wkid||JSON.stringify(e.outSR),a=r.outSpatialReference):i&&(e.returnGeometry||e.returnCentroid)&&(n.outSR=n.inSR,a=u),e.returnGeometry&&delete e.returnGeometry,e.outStatistics&&(n.outStatistics=JSON.stringify(e.outStatistics)),e.pixelSize&&(n.pixelSize=JSON.stringify(e.pixelSize)),e.quantizationParameters&&(r.defaultSpatialReferenceEnabled&&o(u)&&o(r.quantizationParameters)&&o(r.quantizationParameters.extent)&&u.equals(r.quantizationParameters.extent.spatialReference)&&delete e.quantizationParameters.extent.spatialReference,n.quantizationParameters=JSON.stringify(e.quantizationParameters)),e.parameterValues&&(n.parameterValues=JSON.stringify(e.parameterValues)),e.rangeValues&&(n.rangeValues=JSON.stringify(e.rangeValues)),e.dynamicDataSource&&(n.layer=JSON.stringify({source:e.dynamicDataSource}),delete e.dynamicDataSource),e.timeExtent){const d=e.timeExtent,{start:s,end:y}=d;s==null&&y==null||(n.time=s===y?s:`${s!=null?s:"null"},${y!=null?y:"null"}`),delete e.timeExtent}return r.defaultSpatialReferenceEnabled&&o(u)&&o(a)&&u.equals(a)&&(n.defaultSR=n.inSR,delete n.inSR,delete n.outSR),n}async function q(r,t,i,e){const n=o(t.timeExtent)&&t.timeExtent.isEmpty?{data:{features:[]}}:await l(r,t,"json",e);return g(t,i,n.data),n}async function P(r,t,i,e){if(o(t.timeExtent)&&t.timeExtent.isEmpty)return{data:i.createFeatureResult()};const n=await x(r,t,e),a=n;return a.data=b(n.data,i),a}function x(r,t,i){return l(r,t,"pbf",i)}function J(r,t,i){return o(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):l(r,t,"json",i,{returnIdsOnly:!0})}function N(r,t,i){return o(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):l(r,t,"json",i,{returnIdsOnly:!0,returnCountOnly:!0})}function z(r,t,i){return o(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):l(r,t,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}).then(e=>{const n=e.data;if(n.hasOwnProperty("extent"))return e;if(n.features)throw new Error(f);if(n.hasOwnProperty("count"))throw new Error(f);return e})}function l(r,t,i,e={},n={}){const a=typeof r=="string"?O(r):r,u=t.geometry?[t.geometry]:[];return e.responseType=i==="pbf"?"array-buffer":"json",j(u,null,e).then(c=>{const d=c&&c[0];o(d)&&((t=t.clone()).geometry=d);const s=m({...a.query,f:i,...n,...S(t,n)});return R(F(a.path,"query"),{...e,query:{...s,...e.query}})})}const I=Object.freeze(Object.defineProperty({__proto__:null,encodeGeometry:p,executeQuery:q,executeQueryForCount:N,executeQueryForExtent:z,executeQueryForIds:J,executeQueryPBF:P,executeQueryPBFBuffer:x,queryToQueryStringParameters:S,runQuery:l},Symbol.toStringTag,{value:"Module"}));export{N as S,q as c,P as d,x as f,J as p,I as q,m as t,z as x};
