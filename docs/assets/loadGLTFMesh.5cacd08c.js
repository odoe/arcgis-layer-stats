import{r as u,L as G,gN as N,e3 as R,ah as T,dV as h,gP as M,ed as _,cZ as D,t as V}from"./index.e3323316.js";import{g as L}from"./mat3.fb21bf19.js";import{a as B}from"./quatf64.74f3afdd.js";import{p as j,m as k,c as q,g as z}from"./meshFeatureSet.132f3bbf.js";import{T as Z,i as S,c as O,x as P,u as K,L as Q,O as F,E as U}from"./BufferView.5cb8d685.js";import{t as W,r as X,o as Y,a as H,f as J,e as ee,n as te}from"./vec33.57a01f7e.js";import{n as re,m as oe,r as b,a as ne,f as se,t as E,b as ae,d as ie,o as ue,e as ce,c as le,i as fe,g as me,h as pe,j as ge,k as de}from"./DefaultMaterial_COLOR_GAMMA.e64eb600.js";import{b as xe}from"./georeference.0955acb2.js";import{E as A,D as C}from"./enums.23a7fab5.js";import"./earcut.afc1d357.js";import"./deduplicate.0655ac8f.js";import"./projection.a8a5390b.js";import"./mat4f64.ff2a477c.js";import"./vec2.7dab5ab1.js";import"./types.44c7402c.js";import"./Version.f55580df.js";import"./quat.9c13792a.js";import"./vectorStacks.e57f2474.js";import"./byteSizeEstimations.0938bf46.js";import"./lineSegment.6c8673f8.js";async function We(e,t,o){const s=new re($e(o)),r=(await oe(s,t,o,!0)).model,m=r.lods.shift(),l=new Map,c=new Map;r.textures.forEach(($,y)=>l.set(y,be($))),r.materials.forEach(($,y)=>c.set(y,ve($,l)));const i=he(m);for(const $ of i.parts)we(i,$,c);const{position:g,normal:f,tangent:n,color:a,texCoord0:p}=i.vertexAttributes,x={position:g.typedBuffer,normal:u(f)?f.typedBuffer:null,tangent:u(n)?n.typedBuffer:null,uv:u(p)?p.typedBuffer:null,color:u(a)?a.typedBuffer:null},w=xe(x,e,o);return{transform:w.transform,components:i.components,spatialReference:e.spatialReference,vertexAttributes:new j({position:w.vertexAttributes.position,normal:w.vertexAttributes.normal,tangent:w.vertexAttributes.tangent,color:x.color,uv:x.uv})}}function $e(e){return e!=null&&e.resolveFile?{busy:!1,request:async(t,o,s)=>{const r=e.resolveFile(t);return(await G(r,{responseType:o==="image"?"image":o==="binary"?"array-buffer":"json",signal:u(s)?s.signal:null})).data}}:null}function v(e,t){if(V(e))return"-";const o=e.typedBuffer;return`${N(t,o.buffer,()=>t.size)}/${o.byteOffset}/${o.byteLength}`}function Te(e){return u(e)?e.toString():"-"}function he(e){let t=0;const o={color:!1,tangent:!1,normal:!1,texCoord0:!1},s=new Map,r=new Map,m=[];for(const l of e.parts){const{attributes:{position:c,normal:i,color:g,tangent:f,texCoord0:n}}=l,a=`
      ${v(c,s)}/
      ${v(i,s)}/
      ${v(g,s)}/
      ${v(f,s)}/
      ${v(n,s)}/
      ${Te(l.transform)}
    `;let p=!1;const x=N(r,a,()=>(p=!0,{start:t,length:c.count}));p&&(t+=c.count),i&&(o.normal=!0),g&&(o.color=!0),f&&(o.tangent=!0),n&&(o.texCoord0=!0),m.push({gltf:l,writeVertices:p,region:x})}return{vertexAttributes:{position:b(Z,t),normal:o.normal?b(S,t):null,tangent:o.tangent?b(O,t):null,color:o.color?b(P,t):null,texCoord0:o.texCoord0?b(K,t):null},parts:m,components:[]}}function be(e){return new k({data:e.data,wrap:Ce(e.parameters.wrap)})}function ve(e,t){const o=new R(Re(e.color,e.opacity)),s=e.emissiveFactor?new R(Me(e.emissiveFactor)):null;return new q({color:o,colorTexture:T(h(e.textureColor,r=>t.get(r))),normalTexture:T(h(e.textureNormal,r=>t.get(r))),emissiveColor:s,emissiveTexture:T(h(e.textureEmissive,r=>t.get(r))),occlusionTexture:T(h(e.textureOcclusion,r=>t.get(r))),alphaMode:Ae(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:T(h(e.textureMetallicRoughness,r=>t.get(r))),colorTextureTransform:e.colorTextureTransform,normalTextureTransform:e.normalTextureTransform,occlusionTextureTransform:e.occlusionTextureTransform,emissiveTextureTransform:e.emissiveTextureTransform,metallicRoughnessTextureTransform:e.metallicRoughnessTextureTransform})}function we(e,t,o){t.writeVertices&&ye(e,t);const s=t.gltf,r=Ee(s.indices||s.attributes.position.count,s.primitiveType),m=t.region.start;if(m)for(let l=0;l<r.length;l++)r[l]+=m;e.components.push(new z({faces:r,material:o.get(s.material),trustSourceNormals:!0}))}function ye(e,t){const{position:o,normal:s,tangent:r,color:m,texCoord0:l}=e.vertexAttributes,c=t.region.start,{attributes:i,transform:g}=t.gltf,f=i.position.count;if(W(o.slice(c,f),i.position,g),u(i.normal)&&u(s)){const n=L(B(),g),a=s.slice(c,f);X(a,i.normal,n),M(n)&&Y(a,a)}else u(s)&&H(s,0,0,1,{dstIndex:c,count:f});if(u(i.tangent)&&u(r)){const n=L(B(),g),a=r.slice(c,f);ne(a,i.tangent,n),M(n)&&se(a,a)}else u(r)&&E(r,0,0,1,1,{dstIndex:c,count:f});if(u(i.texCoord0)&&u(l)?ae(l.slice(c,f),i.texCoord0):u(l)&&ie(l,0,0,{dstIndex:c,count:f}),u(i.color)&&u(m)){const n=i.color,a=m.slice(c,f);if(n.elementCount===4)n instanceof O?ue(a,n,255):n instanceof P?ce(a,n):n instanceof Q&&le(a,n,8);else{E(a,255,255,255,255);const p=F.fromTypedArray(a.typedBuffer,a.typedBufferStride);n instanceof S?J(p,n,255):n instanceof F?ee(p,n):n instanceof U&&te(p,n,8)}}else u(m)&&E(m.slice(c,f),255,255,255,255)}function Ee(e,t){switch(t){case A.TRIANGLES:return pe(e,ge);case A.TRIANGLE_STRIP:return me(e);case A.TRIANGLE_FAN:return fe(e)}}function Ae(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function Ce(e){return{horizontal:I(e.s),vertical:I(e.t)}}function I(e){switch(e){case C.CLAMP_TO_EDGE:return"clamp";case C.MIRRORED_REPEAT:return"mirror";case C.REPEAT:return"repeat"}}function d(e){return e**(1/de)*255}function Re(e,t){return _(d(e[0]),d(e[1]),d(e[2]),t)}function Me(e){return D(d(e[0]),d(e[1]),d(e[2]))}export{We as loadGLTFMesh};
